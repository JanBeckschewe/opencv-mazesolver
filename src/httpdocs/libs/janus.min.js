function Janus(e){if(void 0===Janus.initDone)return e.error("Library not initialized"),{};if(!Janus.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(Janus.log("Library initialized: "+Janus.initDone),(e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:Janus.noop,null===e.server||void 0===e.server)return e.error("Invalid gateway url"),{};var n=!1,r=null,a={},t=null,o=null,s=0,i=e.server;Janus.isArray(i)?(Janus.log("Multiple servers provided ("+i.length+"), will use the first that works"),i=null,o=e.server,Janus.debug(o)):0===i.indexOf("ws")?(n=!0,Janus.log("Using WebSockets to contact Janus: "+i)):(n=!1,Janus.log("Using REST API to contact Janus: "+i));var d=e.iceServers;null==d&&(d=[{urls:"stun:stun.l.google.com:19302"}]);var u=e.iceTransportPolicy,c=e.bundlePolicy,l=e.ipv6;null==l&&(l=!1);var f=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(f=!0===e.withCredentials);var v=null;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(v=e.max_poll_events),v<1&&(v=1);var g=null;void 0!==e.token&&null!==e.token&&(g=e.token);var p=null;void 0!==e.apisecret&&null!==e.apisecret&&(p=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var m=!1,b=null,J={},w=this,h=0,y={};function S(){if(null!=b)if(Janus.debug("Long poll..."),m){var n=i+"/"+b+"?rid="+(new Date).getTime();null!=v&&(n=n+"&maxev="+v),null!=g&&(n=n+"&token="+g),null!=p&&(n=n+"&apisecret="+p),Janus.httpAPICall(n,{verb:"GET",withCredentials:f,success:k,timeout:6e4,error:function(n,r){if(Janus.error(n+":",r),++h>3)return m=!1,void e.error("Lost connection to the gateway (is it down?)");S()}})}else Janus.warn("Is the gateway down? (connected=false)")}function k(e,r){if(h=0,n||null==b||!0===r||setTimeout(S,200),n||!Janus.isArray(e))if("keepalive"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){if(null==(i=e.sender))return void Janus.warn("Missing sender...");if(null==(u=J[i]))return void Janus.debug("This handle is not attached to this session");var a=e.candidate;Janus.debug("Got a trickled candidate on session "+b),Janus.debug(a);var t=u.webrtcStuff;t.pc&&t.remoteSdp?(Janus.debug("Adding remote candidate:",a),a&&!0!==a.completed?t.pc.addIceCandidate(new RTCIceCandidate(a)):t.pc.addIceCandidate()):(Janus.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),t.candidates||(t.candidates=[]),t.candidates.push(a),Janus.debug(t.candidates))}else{if("webrtcup"===e.janus)return Janus.debug("Got a webrtcup event on session "+b),Janus.debug(e),null==(i=e.sender)?void Janus.warn("Missing sender..."):null==(u=J[i])?void Janus.debug("This handle is not attached to this session"):void u.webrtcState(!0);if("hangup"===e.janus){if(Janus.debug("Got a hangup event on session "+b),Janus.debug(e),null==(i=e.sender))return void Janus.warn("Missing sender...");if(null==(u=J[i]))return void Janus.debug("This handle is not attached to this session");u.webrtcState(!1,e.reason),u.hangup()}else if("detached"===e.janus){if(Janus.debug("Got a detached event on session "+b),Janus.debug(e),null==(i=e.sender))return void Janus.warn("Missing sender...");if(null==(u=J[i]))return;u.detached=!0,u.ondetached(),u.detach()}else if("media"===e.janus){if(Janus.debug("Got a media event on session "+b),Janus.debug(e),null==(i=e.sender))return void Janus.warn("Missing sender...");if(null==(u=J[i]))return void Janus.debug("This handle is not attached to this session");u.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){if(Janus.debug("Got a slowlink event on session "+b),Janus.debug(e),null==(i=e.sender))return void Janus.warn("Missing sender...");if(null==(u=J[i]))return void Janus.debug("This handle is not attached to this session");u.slowLink(e.uplink,e.nacks)}else{if("error"===e.janus){var o,s;if(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),Janus.debug(e),null!=(o=e.transaction))null!=(s=y[o])&&s(e),delete y[o];return}if("event"===e.janus){var i;if(Janus.debug("Got a plugin event on session "+b),Janus.debug(e),null==(i=e.sender))return void Janus.warn("Missing sender...");var d=e.plugindata;if(null==d)return void Janus.warn("Missing plugindata...");Janus.debug("  -- Event is coming from "+i+" ("+d.plugin+")");var u,c=d.data;if(Janus.debug(c),null==(u=J[i]))return void Janus.warn("This handle is not attached to this session");var l=e.jsep;null!=l&&(Janus.debug("Handling SDP as well..."),Janus.debug(l));var f=u.onmessage;null!=f?(Janus.debug("Notifying application..."),f(c,l)):Janus.debug("No provided notification callback")}else Janus.warn("Unknown message/event  '"+e.janus+"' on session "+b),Janus.debug(e)}}else Janus.debug("Got a success on session "+b),Janus.debug(e),null!=(o=e.transaction)&&(null!=(s=y[o])&&s(e),delete y[o]);else Janus.debug("Got an ack on session "+b),Janus.debug(e),null!=(o=e.transaction)&&(null!=(s=y[o])&&s(e),delete y[o]);else Janus.vdebug("Got a keepalive on session "+b);else for(var v=0;v<e.length;v++)k(e[v],!0)}function T(){if(null!==i&&n&&m){t=setTimeout(T,3e4);var e={janus:"keepalive",session_id:b,transaction:Janus.randomString(12)};null!=g&&(e.token=g),null!=p&&(e.apisecret=p),r.send(JSON.stringify(e))}}function A(d){var u=Janus.randomString(12),c={janus:"create",transaction:u};if(d.reconnect&&(m=!1,c.janus="claim",c.session_id=b,r&&(r.onopen=null,r.onerror=null,r.onclose=null,t&&(clearTimeout(t),t=null))),null!=g&&(c.token=g),null!=p&&(c.apisecret=p),null===i&&Janus.isArray(o)&&(0===(i=o[s]).indexOf("ws")?(n=!0,Janus.log("Server #"+(s+1)+": trying WebSockets to contact Janus ("+i+")")):(n=!1,Janus.log("Server #"+(s+1)+": trying REST API to contact Janus ("+i+")"))),n)for(var l in r=Janus.newWebSocket(i,"janus-protocol"),a={error:function(){if(Janus.error("Error connecting to the Janus WebSockets server... "+i),Janus.isArray(o))return++s==o.length?void d.error("Error connecting to any of the provided Janus servers: Is the gateway down?"):(i=null,void setTimeout(function(){A(d)},200));d.error("Error connecting to the Janus WebSockets server: Is the gateway down?")},open:function(){y[u]=function(e){if(Janus.debug(e),"success"!==e.janus)return Janus.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);t=setTimeout(T,3e4),m=!0,b=e.session_id?e.session_id:e.data.id,d.reconnect?Janus.log("Claimed session: "+b):Janus.log("Created session: "+b),Janus.sessions[b]=w,d.success()},r.send(JSON.stringify(c))},message:function(e){k(JSON.parse(e.data))},close:function(){null!==i&&m&&(m=!1,e.error("Lost connection to the gateway (is it down?)"))}})r.addEventListener(l,a[l]);else Janus.httpAPICall(i,{verb:"POST",withCredentials:f,body:c,success:function(e){if(Janus.debug(e),"success"!==e.janus)return Janus.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);m=!0,b=e.session_id?e.session_id:e.data.id,d.reconnect?Janus.log("Claimed session: "+b):Janus.log("Created session: "+b),Janus.sessions[b]=w,S(),d.success()},error:function(e,n){if(Janus.error(e+":",n),Janus.isArray(o))return++s==o.length?void d.error("Error connecting to any of the provided Janus servers: Is the gateway down?"):(i=null,void setTimeout(function(){A(d)},200));""===n?d.error(e+": Is the gateway down?"):d.error(e+": "+n)}})}function C(e,a){if((a=a||{}).success="function"==typeof a.success?a.success:Janus.noop,a.error="function"==typeof a.error?a.error:Janus.noop,!m)return Janus.warn("Is the gateway down? (connected=false)"),void a.error("Is the gateway down? (connected=false)");var t=J[e];if(null==t||null===t.webrtcStuff||void 0===t.webrtcStuff)return Janus.warn("Invalid handle"),void a.error("Invalid handle");var o=a.message,s=a.jsep,d=Janus.randomString(12),u={janus:"message",body:o,transaction:d};if(null!==t.token&&void 0!==t.token&&(u.token=t.token),null!=p&&(u.apisecret=p),null!=s&&(u.jsep=s),Janus.debug("Sending message to plugin (handle="+e+"):"),Janus.debug(u),n)return u.session_id=b,u.handle_id=e,y[d]=function(e){if(Janus.debug("Message sent!"),Janus.debug(e),"success"===e.janus){var n=e.plugindata;if(null==n)return Janus.warn("Request succeeded, but missing plugindata..."),void a.success();Janus.log("Synchronous transaction successful ("+n.plugin+")");var r=n.data;return Janus.debug(r),void a.success(r)}"ack"===e.janus?a.success():void 0!==e.error&&null!==e.error?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),a.error(e.error.code+" "+e.error.reason)):(Janus.error("Unknown error"),a.error("Unknown error"))},void r.send(JSON.stringify(u));Janus.httpAPICall(i+"/"+b+"/"+e,{verb:"POST",withCredentials:f,body:u,success:function(e){if(Janus.debug("Message sent!"),Janus.debug(e),"success"===e.janus){var n=e.plugindata;if(null==n)return Janus.warn("Request succeeded, but missing plugindata..."),void a.success();Janus.log("Synchronous transaction successful ("+n.plugin+")");var r=n.data;return Janus.debug(r),void a.success(r)}"ack"===e.janus?a.success():void 0!==e.error&&null!==e.error?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),a.error(e.error.code+" "+e.error.reason)):(Janus.error("Unknown error"),a.error("Unknown error"))},error:function(e,n){Janus.error(e+":",n),a.error(e+": "+n)}})}function D(e,a){if(m){var t=J[e];if(null==t||null===t.webrtcStuff||void 0===t.webrtcStuff)return Janus.warn("Invalid handle"),void callbacks.error("Invalid handle");var o={janus:"trickle",candidate:a,transaction:Janus.randomString(12)};if(null!==t.token&&void 0!==t.token&&(o.token=t.token),null!=p&&(o.apisecret=p),Janus.vdebug("Sending trickle candidate (handle="+e+"):"),Janus.vdebug(o),n)return o.session_id=b,o.handle_id=e,void r.send(JSON.stringify(o));Janus.httpAPICall(i+"/"+b+"/"+e,{verb:"POST",withCredentials:f,body:o,success:function(e){Janus.vdebug("Candidate sent!"),Janus.vdebug(e),"ack"===e.janus||Janus.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,n){Janus.error(e+":",n)}})}else Janus.warn("Is the gateway down? (connected=false)")}function R(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var r=J[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var a=r.webrtcStuff,t=n.text;if(null==t)return Janus.warn("Invalid text"),void n.error("Invalid text");Janus.log("Sending string on data channel: "+t),a.dataChannel.send(t),n.success()}function I(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var r=J[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var a=r.webrtcStuff;if(null===a.dtmfSender||void 0===a.dtmfSender){if(void 0!==a.pc&&null!==a.pc){var t=a.pc.getSenders().find(function(e){return e.track&&"audio"===e.track.kind});if(!t)return Janus.warn("Invalid DTMF configuration (no audio track)"),void n.error("Invalid DTMF configuration (no audio track)");a.dtmfSender=t.dtmf,a.dtmfSender&&(Janus.log("Created DTMF Sender"),a.dtmfSender.ontonechange=function(e){Janus.debug("Sent DTMF tone: "+e.tone)})}if(null===a.dtmfSender||void 0===a.dtmfSender)return Janus.warn("Invalid DTMF configuration"),void n.error("Invalid DTMF configuration")}var o=n.dtmf;if(null==o)return Janus.warn("Invalid DTMF parameters"),void n.error("Invalid DTMF parameters");var s=o.tones;if(null==s)return Janus.warn("Invalid DTMF string"),void n.error("Invalid DTMF string");var i=o.duration;null==i&&(i=500);var d=o.gap;null==d&&(d=50),Janus.debug("Sending DTMF string "+s+" (duration "+i+"ms, gap "+d+"ms)"),a.dtmfSender.insertDTMF(s,i,d)}function x(e,a){(a=a||{}).success="function"==typeof a.success?a.success:Janus.noop,a.error="function"==typeof a.error?a.error:Janus.noop;var t=!0;void 0!==a.asyncRequest&&null!==a.asyncRequest&&(t=!0===a.asyncRequest),Janus.log("Destroying handle "+e+" (async="+t+")"),N(e);var o=J[e];if(null==o||o.detached)return delete J[e],void a.success();if(!m)return Janus.warn("Is the gateway down? (connected=false)"),void a.error("Is the gateway down? (connected=false)");var s={janus:"detach",transaction:Janus.randomString(12)};if(null!==o.token&&void 0!==o.token&&(s.token=o.token),null!=p&&(s.apisecret=p),n)return s.session_id=b,s.handle_id=e,r.send(JSON.stringify(s)),delete J[e],void a.success();Janus.httpAPICall(i+"/"+b+"/"+e,{verb:"POST",async:t,withCredentials:f,body:s,success:function(n){Janus.log("Destroyed handle:"),Janus.debug(n),"success"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),delete J[e],a.success()},error:function(n,r){Janus.error(n+":",r),delete J[e],a.success()}})}function V(e,n,r,a,t){var o=J[e];if(null==o||null===o.webrtcStuff||void 0===o.webrtcStuff)return Janus.warn("Invalid handle"),void a.error("Invalid handle");var s=o.webrtcStuff;Janus.debug("streamsDone:",t),t&&(Janus.debug("  -- Audio tracks:",t.getAudioTracks()),Janus.debug("  -- Video tracks:",t.getVideoTracks()));var i=!1;if(s.myStream&&r.update&&!s.streamExternal){if((!r.update&&U(r)||r.update&&(r.addAudio||r.replaceAudio))&&t.getAudioTracks()&&t.getAudioTracks().length)if(s.myStream.addTrack(t.getAudioTracks()[0]),r.replaceAudio&&"firefox"===Janus.webRTCAdapter.browserDetails.browser)for(var f in Janus.log("Replacing audio track:",t.getAudioTracks()[0]),s.pc.getSenders()){(p=s.pc.getSenders()[f])&&p.track&&"audio"===p.track.kind&&p.replaceTrack(t.getAudioTracks()[0])}else if("firefox"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=59){Janus.log((r.replaceVideo?"Replacing":"Adding")+" video track:",t.getVideoTracks()[0]);var v=null;if((m=s.pc.getTransceivers())&&m.length>0)for(var g in m){if((w=m[g]).sender&&w.sender.track&&"audio"===w.sender.track.kind||w.receiver&&w.receiver.track&&"audio"===w.receiver.track.kind){v=w;break}}v&&v.sender?v.sender.replaceTrack(t.getVideoTracks()[0]):s.pc.addTrack(t.getVideoTracks()[0],t)}else Janus.log((r.replaceAudio?"Replacing":"Adding")+" audio track:",t.getAudioTracks()[0]),s.pc.addTrack(t.getAudioTracks()[0],t);if((!r.update&&_(r)||r.update&&(r.addVideo||r.replaceVideo))&&t.getVideoTracks()&&t.getVideoTracks().length)if(s.myStream.addTrack(t.getVideoTracks()[0]),r.replaceVideo&&"firefox"===Janus.webRTCAdapter.browserDetails.browser)for(var f in Janus.log("Replacing video track:",t.getVideoTracks()[0]),s.pc.getSenders()){var p;(p=s.pc.getSenders()[f])&&p.track&&"video"===p.track.kind&&p.replaceTrack(t.getVideoTracks()[0])}else if("firefox"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=59){Janus.log((r.replaceVideo?"Replacing":"Adding")+" video track:",t.getVideoTracks()[0]);var m,b=null;if((m=s.pc.getTransceivers())&&m.length>0)for(var g in m){var w;if((w=m[g]).sender&&w.sender.track&&"video"===w.sender.track.kind||w.receiver&&w.receiver.track&&"video"===w.receiver.track.kind){b=w;break}}b&&b.sender?b.sender.replaceTrack(t.getVideoTracks()[0]):s.pc.addTrack(t.getVideoTracks()[0],t)}else Janus.log((r.replaceVideo?"Replacing":"Adding")+" video track:",t.getVideoTracks()[0]),s.pc.addTrack(t.getVideoTracks()[0],t)}else s.myStream=t,i=!0;if(!s.pc){var h={iceServers:d,iceTransportPolicy:u,bundlePolicy:c},y={optional:[{DtlsSrtpKeyAgreement:!0}]};if(!0===l&&y.optional.push({googIPv6:!0}),a.rtcConstraints&&"object"==typeof a.rtcConstraints)for(var g in Janus.debug("Adding custom PeerConnection constraints:",a.rtcConstraints),a.rtcConstraints)y.optional.push(a.rtcConstraints[g]);"edge"===Janus.webRTCAdapter.browserDetails.browser&&(h.bundlePolicy="max-bundle"),Janus.log("Creating PeerConnection"),Janus.debug(y),s.pc=new RTCPeerConnection(h,y),Janus.debug(s.pc),s.pc.getStats&&(s.volume.value=0,s.bitrate.value="0 kbits/sec"),Janus.log("Preparing local SDP and gathering candidates (trickle="+s.trickle+")"),s.pc.oniceconnectionstatechange=function(e){s.pc&&o.iceState(s.pc.iceConnectionState)},s.pc.onicecandidate=function(n){if(null==n.candidate||"edge"===Janus.webRTCAdapter.browserDetails.browser&&n.candidate.candidate.indexOf("endOfCandidates")>0)Janus.log("End of candidates."),s.iceDone=!0,!0===s.trickle?D(e,{completed:!0}):function(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var r=J[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return void Janus.warn("Invalid handle, not sending anything");var a=r.webrtcStuff;if(Janus.log("Sending offer/answer SDP..."),null===a.mySdp||void 0===a.mySdp)return void Janus.warn("Local SDP instance is invalid, not sending anything...");a.mySdp={type:a.pc.localDescription.type,sdp:a.pc.localDescription.sdp},!1===a.trickle&&(a.mySdp.trickle=!1);Janus.debug(n),a.sdpSent=!0,n.success(a.mySdp)}(e,a);else{var r={candidate:n.candidate.candidate,sdpMid:n.candidate.sdpMid,sdpMLineIndex:n.candidate.sdpMLineIndex};!0===s.trickle&&D(e,r)}},s.pc.ontrack=function(e){Janus.log("Handling Remote Track"),Janus.debug(e),e.streams&&(s.remoteStream=e.streams[0],o.onremotestream(s.remoteStream),e.track&&!e.track.onended&&(Janus.log("Adding onended callback to track:",e.track),e.track.onended=function(e){Janus.log("Remote track removed:",e),s.remoteStream&&(s.remoteStream.removeTrack(e.target),o.onremotestream(s.remoteStream))}))}}if(i&&null!=t&&(Janus.log("Adding local stream"),t.getTracks().forEach(function(e){Janus.log("Adding local track:",e),s.pc.addTrack(e,t)})),function(e){if(Janus.debug("isDataEnabled:",e),"edge"==Janus.webRTCAdapter.browserDetails.browser)return Janus.warn("Edge doesn't support data channels yet"),!1;return null!=e&&!0===e.data}(r)&&!s.dataChannel){Janus.log("Creating data channel");var S=function(){var e=null!==s.dataChannel?s.dataChannel.readyState:"null";Janus.log("State change on data channel: "+e),"open"===e&&o.ondataopen()};s.dataChannel=s.pc.createDataChannel("JanusDataChannel",{ordered:!1}),s.dataChannel.onmessage=function(e){Janus.log("Received message on data channel: "+e.data),o.ondata(e.data)},s.dataChannel.onopen=S,s.dataChannel.onclose=S,s.dataChannel.onerror=function(e){Janus.error("Got error on data channel:",e)}}s.myStream&&o.onlocalstream(s.myStream),null==n?function(e,n,r){(r=r||{}).success="function"==typeof r.success?r.success:Janus.noop,r.error="function"==typeof r.error?r.error:Janus.noop;var a=J[e];if(null==a||null===a.webrtcStuff||void 0===a.webrtcStuff)return Janus.warn("Invalid handle"),void r.error("Invalid handle");var t=a.webrtcStuff,o=!0===r.simulcast;o?Janus.log("Creating offer (iceDone="+t.iceDone+", simulcast="+o+")"):Janus.log("Creating offer (iceDone="+t.iceDone+")");var s={};if("firefox"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=59){var i=null,d=null,u=t.pc.getTransceivers();if(u&&u.length>0)for(var c in u){var l=u[c];l.sender&&l.sender.track&&"audio"===l.sender.track.kind||l.receiver&&l.receiver.track&&"audio"===l.receiver.track.kind?i||(i=l):(l.sender&&l.sender.track&&"video"===l.sender.track.kind||l.receiver&&l.receiver.track&&"video"===l.receiver.track.kind)&&(d||(d=l))}var f=U(n),v=W(n);f||v?f&&v?i&&(i.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",i)):f&&!v?i&&(i.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",i)):!f&&v&&(i?(i.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",i)):(i=t.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",i))):n.removeAudio&&i&&(i.direction="inactive",Janus.log("Setting audio transceiver to inactive:",i));var g=_(n),p=q(n);g||p?g&&p?d&&(d.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",d)):g&&!p?d&&(d.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",d)):!g&&p&&(d?(d.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",d)):(d=t.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",d))):n.removeVideo&&d&&(d.direction="inactive",Janus.log("Setting video transceiver to inactive:",d))}else s.offerToReceiveAudio=W(n),s.offerToReceiveVideo=q(n);!0===r.iceRestart&&(s.iceRestart=!0);Janus.debug(s);var m=_(n);if(m&&o&&"firefox"===Janus.webRTCAdapter.browserDetails.browser){Janus.log("Enabling Simulcasting for Firefox (RID)");var b=t.pc.getSenders()[1];Janus.log(b);var w=b.getParameters();Janus.log(w),b.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:1e6},{rid:"medium",active:!0,priority:"medium",maxBitrate:3e5},{rid:"low",active:!0,priority:"low",maxBitrate:1e5}]})}t.pc.createOffer(function(e){if(Janus.debug(e),Janus.log("Setting local description"),m&&o&&("chrome"===Janus.webRTCAdapter.browserDetails.browser?(Janus.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=function(e){for(var n=e.split("\r\n"),r=!1,a=[-1],t=[-1],o=null,s=null,i=null,d=null,u=-1,c=0;c<n.length;c++){var l=n[c].match(/m=(\w+) */);if(l){var f=l[1];if("video"===f){if(!(a[0]<0)){u=c;break}r=!0}else if(a[0]>-1){u=c;break}}else if(r){var v=n[c].match(/a=ssrc-group:FID (\d+) (\d+)/);if(v)a[0]=v[1],t[0]=v[2],n.splice(c,1),c--;else{if(a[0]){var g=n[c].match("a=ssrc:"+a[0]+" cname:(.+)");if(g&&(o=g[1]),(g=n[c].match("a=ssrc:"+a[0]+" msid:(.+)"))&&(s=g[1]),(g=n[c].match("a=ssrc:"+a[0]+" mslabel:(.+)"))&&(i=g[1]),(g=n[c].match("a=ssrc:"+a+" label:(.+)"))&&(d=g[1]),0===n[c].indexOf("a=ssrc:"+t)){n.splice(c,1),c--;continue}if(0===n[c].indexOf("a=ssrc:"+a[0])){n.splice(c,1),c--;continue}}0!=n[c].length||(n.splice(c,1),c--)}}}if(a[0]<0){u=-1,r=!1;for(var c=0;c<n.length;c++){var l=n[c].match(/m=(\w+) */);if(l){var f=l[1];if("video"===f){if(!(a[0]<0)){u=c;break}r=!0}else if(a[0]>-1){u=c;break}}else if(r){if(a[0]<0){var p=n[c].match(/a=ssrc:(\d+)/);if(p){a[0]=p[1],n.splice(c,1),c--;continue}}else{var g=n[c].match("a=ssrc:"+a[0]+" cname:(.+)");if(g&&(o=g[1]),(g=n[c].match("a=ssrc:"+a[0]+" msid:(.+)"))&&(s=g[1]),(g=n[c].match("a=ssrc:"+a[0]+" mslabel:(.+)"))&&(i=g[1]),(g=n[c].match("a=ssrc:"+a[0]+" label:(.+)"))&&(d=g[1]),0===n[c].indexOf("a=ssrc:"+t[0])){n.splice(c,1),c--;continue}if(0===n[c].indexOf("a=ssrc:"+a[0])){n.splice(c,1),c--;continue}}0!=n[c].length||(n.splice(c,1),c--)}}}if(a[0]<0)return Janus.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;u<0&&(u=n.length);a[1]=Math.floor(4294967295*Math.random()),a[2]=Math.floor(4294967295*Math.random()),t[1]=Math.floor(4294967295*Math.random()),t[2]=Math.floor(4294967295*Math.random());for(var c=0;c<a.length;c++)o&&(n.splice(u,0,"a=ssrc:"+a[c]+" cname:"+o),u++),s&&(n.splice(u,0,"a=ssrc:"+a[c]+" msid:"+s),u++),i&&(n.splice(u,0,"a=ssrc:"+a[c]+" mslabel:"+i),u++),d&&(n.splice(u,0,"a=ssrc:"+a[c]+" label:"+d),u++),o&&(n.splice(u,0,"a=ssrc:"+t[c]+" cname:"+o),u++),s&&(n.splice(u,0,"a=ssrc:"+t[c]+" msid:"+s),u++),i&&(n.splice(u,0,"a=ssrc:"+t[c]+" mslabel:"+i),u++),d&&(n.splice(u,0,"a=ssrc:"+t[c]+" label:"+d),u++);n.splice(u,0,"a=ssrc-group:FID "+a[2]+" "+t[2]),n.splice(u,0,"a=ssrc-group:FID "+a[1]+" "+t[1]),n.splice(u,0,"a=ssrc-group:FID "+a[0]+" "+t[0]),n.splice(u,0,"a=ssrc-group:SIM "+a[0]+" "+a[1]+" "+a[2]),(e=n.join("\r\n")).endsWith("\r\n")||(e+="\r\n");return e}(e.sdp)):"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),t.mySdp=e.sdp,t.pc.setLocalDescription(e),t.mediaConstraints=s,t.iceDone||t.trickle){Janus.log("Offer ready"),Janus.debug(r);var n={type:e.type,sdp:e.sdp};r.success(n)}else Janus.log("Waiting for all candidates...")},r.error,s)}(e,r,a):s.pc.setRemoteDescription(new RTCSessionDescription(n),function(){if(Janus.log("Remote description accepted!"),s.remoteSdp=n.sdp,s.candidates&&s.candidates.length>0){for(var t in s.candidates){var o=s.candidates[t];Janus.debug("Adding remote candidate:",o),o&&!0!==o.completed?s.pc.addIceCandidate(new RTCIceCandidate(o)):s.pc.addIceCandidate()}s.candidates=[]}!function(e,n,r){(r=r||{}).success="function"==typeof r.success?r.success:Janus.noop,r.error="function"==typeof r.error?r.error:Janus.noop;var a=J[e];if(null==a||null===a.webrtcStuff||void 0===a.webrtcStuff)return Janus.warn("Invalid handle"),void r.error("Invalid handle");var t=a.webrtcStuff,o=!0===r.simulcast;o?Janus.log("Creating answer (iceDone="+t.iceDone+", simulcast="+o+")"):Janus.log("Creating answer (iceDone="+t.iceDone+")");var s=null;if("firefox"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=59){s={};var i=null,d=null,u=t.pc.getTransceivers();if(u&&u.length>0)for(var c in u){var l=u[c];l.sender&&l.sender.track&&"audio"===l.sender.track.kind||l.receiver&&l.receiver.track&&"audio"===l.receiver.track.kind?i||(i=l):(l.sender&&l.sender.track&&"video"===l.sender.track.kind||l.receiver&&l.receiver.track&&"video"===l.receiver.track.kind)&&(d||(d=l))}var f=U(n),v=W(n);f||v?f&&v?i&&(i.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",i)):f&&!v?i&&(i.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",i)):!f&&v&&(i?(i.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",i)):(i=t.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",i))):n.removeAudio&&i&&(i.direction="inactive",Janus.log("Setting audio transceiver to inactive:",i));var g=_(n),p=q(n);g||p?g&&p?d&&(d.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",d)):g&&!p?d&&(d.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",d)):!g&&p&&(d?(d.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",d)):(d=t.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",d))):n.removeVideo&&d&&(d.direction="inactive",Janus.log("Setting video transceiver to inactive:",d))}else s="firefox"==Janus.webRTCAdapter.browserDetails.browser||"edge"==Janus.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:W(n),offerToReceiveVideo:q(n)}:{mandatory:{OfferToReceiveAudio:W(n),OfferToReceiveVideo:q(n)}};Janus.debug(s);var m=_(n);if(m&&o&&"firefox"===Janus.webRTCAdapter.browserDetails.browser){Janus.log("Enabling Simulcasting for Firefox (RID)");var b=t.pc.getSenders()[1];Janus.log(b);var w=b.getParameters();Janus.log(w),b.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:1e6},{rid:"medium",active:!0,priority:"medium",maxBitrate:3e5},{rid:"low",active:!0,priority:"low",maxBitrate:1e5}]})}t.pc.createAnswer(function(e){if(Janus.debug(e),Janus.log("Setting local description"),m&&o&&("chrome"===Janus.webRTCAdapter.browserDetails.browser?Janus.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),t.mySdp=e.sdp,t.pc.setLocalDescription(e),t.mediaConstraints=s,t.iceDone||t.trickle){var n={type:e.type,sdp:e.sdp};r.success(n)}else Janus.log("Waiting for all candidates...")},r.error,s)}(e,r,a)},a.error)}function j(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:L;var r=n.jsep;n.media=n.media||{audio:!0,video:!0};var a=n.media,t=J[e];if(null==t||null===t.webrtcStuff||void 0===t.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var o,s=t.webrtcStuff;if(s.trickle=(o=n.trickle,Janus.debug("isTrickleEnabled:",o),null==o||!0===o),void 0===s.pc||null===s.pc)a.update=!1;else if(void 0!==s.pc&&null!==s.pc)if(Janus.log("Updating existing media session"),a.update=!0,null!==n.stream&&void 0!==n.stream)n.stream!==s.myStream&&Janus.log("Renegotiation involves a new external stream");else{if(a.addAudio){if(a.replaceAudio=!1,a.removeAudio=!1,a.audioSend=!0,s.myStream&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length)return Janus.error("Can't add audio stream, there already is one"),void n.error("Can't add audio stream, there already is one")}else a.removeAudio?(a.replaceAudio=!1,a.addAudio=!1,a.audioSend=!1):a.replaceAudio&&(a.addAudio=!1,a.removeAudio=!1,a.audioSend=!0);if(null===s.myStream||void 0===s.myStream?(a.replaceAudio&&(a.replaceAudio=!1,a.addAudio=!0,a.audioSend=!0),U(a)&&(a.addAudio=!0)):null!==s.myStream.getAudioTracks()&&void 0!==s.myStream.getAudioTracks()&&0!==s.myStream.getAudioTracks().length||(a.replaceAudio&&(a.replaceAudio=!1,a.addAudio=!0,a.audioSend=!0),U(a)&&(a.addAudio=!0)),a.addVideo){if(a.replaceVideo=!1,a.removeVideo=!1,a.videoSend=!0,s.myStream&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length)return Janus.error("Can't add video stream, there already is one"),void n.error("Can't add video stream, there already is one")}else a.removeVideo?(a.replaceVideo=!1,a.addVideo=!1,a.videoSend=!1):a.replaceVideo&&(a.addVideo=!1,a.removeVideo=!1,a.videoSend=!0);null===s.myStream||void 0===s.myStream?(a.replaceVideo&&(a.replaceVideo=!1,a.addVideo=!0,a.videoSend=!0),_(a)&&(a.addVideo=!0)):null!==s.myStream.getVideoTracks()&&void 0!==s.myStream.getVideoTracks()&&0!==s.myStream.getVideoTracks().length||(a.replaceVideo&&(a.replaceVideo=!1,a.addVideo=!0,a.videoSend=!0),_(a)&&(a.addVideo=!0)),a.addData&&(a.data=!0)}if(a.update&&!s.streamExternal){if(a.removeAudio||a.replaceAudio){if(s.myStream&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length){var i=s.myStream.getAudioTracks()[0];Janus.log("Removing audio track:",i),s.myStream.removeTrack(i);try{i.stop()}catch(e){}}if(s.pc.getSenders()&&s.pc.getSenders().length){var d=!0;if(a.replaceAudio&&"firefox"===Janus.webRTCAdapter.browserDetails.browser&&(d=!1),d)for(var u in s.pc.getSenders()){(i=s.pc.getSenders()[u])&&i.track&&"audio"===i.track.kind&&(Janus.log("Removing audio sender:",i),s.pc.removeTrack(i))}}}if(a.removeVideo||a.replaceVideo){if(s.myStream&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length){i=s.myStream.getVideoTracks()[0];Janus.log("Removing video track:",i),s.myStream.removeTrack(i);try{i.stop()}catch(e){}}if(s.pc.getSenders()&&s.pc.getSenders().length){var c=!0;if(a.replaceVideo&&"firefox"===Janus.webRTCAdapter.browserDetails.browser&&(c=!1),c)for(var u in s.pc.getSenders()){(i=s.pc.getSenders()[u])&&i.track&&"video"===i.track.kind&&(Janus.log("Removing video sender:",i),s.pc.removeTrack(i))}}}}if(null!==n.stream&&void 0!==n.stream){var l=n.stream;if(Janus.log("MediaStream provided by the application"),Janus.debug(l),a.update&&s.myStream&&s.myStream!==n.stream&&!s.streamExternal){try{var f=s.myStream.getTracks();for(var v in f){var g=f[v];Janus.log(g),null!=g&&g.stop()}}catch(e){}s.myStream=null}return s.streamExternal=!0,void V(e,r,a,n,l)}if(U(a)||_(a)){var p={mandatory:{},optional:[]};t.consentDialog(!0);var m=U(a);!0===m&&null!=a&&null!=a&&"object"==typeof a.audio&&(m=a.audio);var b=_(a);if(!0===b&&null!=a&&null!=a)if(!(!0===n.simulcast)||r||void 0!==a.video&&!1!==a.video||(a.video="hires"),a.video&&"screen"!=a.video&&"window"!=a.video)if("object"==typeof a.video)b=a.video;else{var w=0,h=0;"lowres"===a.video?(h=240,240,w=320):"lowres-16:9"===a.video?(h=180,180,w=320):"hires"===a.video||"hires-16:9"===a.video||"hdres"===a.video?(h=720,720,w=1280):"fhdres"===a.video?(h=1080,1080,w=1920):"4kres"===a.video?(h=2160,2160,w=3840):"stdres"===a.video?(h=480,480,w=640):"stdres-16:9"===a.video?(h=360,360,w=640):(Janus.log("Default video setting is stdres 4:3"),h=480,480,w=640),Janus.log("Adding media constraint:",a.video),b={height:{ideal:h},width:{ideal:w}},Janus.log("Adding video constraint:",b)}else if("screen"===a.video||"window"===a.video){if(a.screenshareFrameRate||(a.screenshareFrameRate=3),"https:"!==window.location.protocol)return Janus.warn("Screen sharing only works on HTTPS, try the https:// version of this page"),t.consentDialog(!1),void n.error("Screen sharing only works on HTTPS, try the https:// version of this page");var y={};function S(o,s){t.consentDialog(!1),o?n.error({code:o.code,name:o.name,message:o.message}):V(e,r,a,n,s)}function k(e,n,r){Janus.log("Adding media constraint (screen capture)"),Janus.debug(e),navigator.mediaDevices.getUserMedia(e).then(function(e){r?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(r){e.addTrack(r.getAudioTracks()[0]),n(null,e)}):n(null,e)}).catch(function(e){t.consentDialog(!1),n(e)})}if("chrome"===Janus.webRTCAdapter.browserDetails.browser){var T=Janus.webRTCAdapter.browserDetails.version,A=33;if(window.navigator.userAgent.match("Linux")&&(A=35),T>=26&&T<=A)k(p={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:a.screenshareFrameRate,maxFrameRate:a.screenshareFrameRate,chromeMediaSource:"screen"}},audio:U(a)},S);else{var C=window.setTimeout(function(){return(D=new Error("NavigatorUserMediaError")).name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',t.consentDialog(!1),n.error(D)},1e3);y[C]=[S,null],window.postMessage({type:"janusGetScreen",id:C},"*")}}else if(window.navigator.userAgent.match("Firefox")){if(!(parseInt(window.navigator.userAgent.match(/Firefox\/(.*)/)[1],10)>=33)){var D=new Error("NavigatorUserMediaError");return D.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",t.consentDialog(!1),void n.error(D)}k(p={video:{mozMediaSource:a.video,mediaSource:a.video},audio:U(a)},function(e,n){if(S(e,n),!e)var r=n.currentTime,a=window.setInterval(function(){n||window.clearInterval(a),n.currentTime==r&&(window.clearInterval(a),n.onended&&n.onended()),r=n.currentTime},500)})}return void window.addEventListener("message",function(e){if(e.origin==window.location.origin)if("janusGotScreen"==e.data.type&&y[e.data.id]){var r=y[e.data.id][0];if(delete y[e.data.id],""===e.data.sourceId){var o=new Error("NavigatorUserMediaError");o.name="You cancelled the request for permission, giving up...",t.consentDialog(!1),n.error(o)}else(p={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:a.screenshareFrameRate,maxFrameRate:a.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=e.data.sourceId,k(p,r,U(a))}else"janusGetScreenPending"==e.data.type&&window.clearTimeout(e.data.id)})}null!=a&&"screen"===a.video||navigator.mediaDevices.enumerateDevices().then(function(o){var s,i,d=o.some(function(e){return"audioinput"===e.kind}),u=o.some(function(e){return"videoinput"===e.kind}),c=U(a),l=_(a),f=(s=a,Janus.debug("isAudioSendRequired:",s),null!=s&&!1!==s.audio&&!1!==s.audioSend&&void 0!==s.failIfNoAudio&&null!==s.failIfNoAudio&&!0===s.failIfNoAudio),v=(i=a,Janus.debug("isVideoSendRequired:",i),null!=i&&!1!==i.video&&!1!==i.videoSend&&void 0!==i.failIfNoVideo&&null!==i.failIfNoVideo&&!0===i.failIfNoVideo);if(c||l||f||v){var g=!!c&&d,p=!!l&&u;if(!g&&!p)return t.consentDialog(!1),n.error("No capture device found"),!1;if(!g&&f)return t.consentDialog(!1),n.error("Audio capture is required, but no capture device found"),!1;if(!p&&v)return t.consentDialog(!1),n.error("Video capture is required, but no capture device found"),!1}var J={audio:!!d&&m,video:!!u&&b};Janus.debug("getUserMedia constraints",J),navigator.mediaDevices.getUserMedia(J).then(function(o){t.consentDialog(!1),V(e,r,a,n,o)}).catch(function(e){t.consentDialog(!1),n.error({code:e.code,name:e.name,message:e.message})})}).catch(function(e){t.consentDialog(!1),n.error("enumerateDevices error",e)})}else V(e,r,a,n)}function O(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:L;var r=n.jsep,a=J[e];if(null==a||null===a.webrtcStuff||void 0===a.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var t=a.webrtcStuff;if(null!=r){if(null===t.pc)return Janus.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void n.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");t.pc.setRemoteDescription(new RTCSessionDescription(r),function(){if(Janus.log("Remote description accepted!"),t.remoteSdp=r.sdp,t.candidates&&t.candidates.length>0){for(var e in t.candidates){var a=t.candidates[e];Janus.debug("Adding remote candidate:",a),a&&!0!==a.completed?t.pc.addIceCandidate(new RTCIceCandidate(a)):t.pc.addIceCandidate()}t.candidates=[]}n.success()},n.error)}else n.error("Invalid JSEP")}function M(e){var n=J[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return Janus.warn("Invalid handle"),0;var r=n.webrtcStuff;return r.pc.getStats&&"chrome"==Janus.webRTCAdapter.browserDetails.browser?null===r.remoteStream||void 0===r.remoteStream?(Janus.warn("Remote stream unavailable"),0):null===r.volume.timer||void 0===r.volume.timer?(Janus.log("Starting volume monitor"),r.volume.timer=setInterval(function(){r.pc.getStats(function(e){for(var n=e.result(),a=0;a<n.length;a++){var t=n[a];"ssrc"==t.type&&t.stat("audioOutputLevel")&&(r.volume.value=t.stat("audioOutputLevel"))}})},200),0):r.volume.value:(Janus.log("Getting the remote volume unsupported by browser"),0)}function P(e,n){var r=J[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return Janus.warn("Invalid handle"),!0;var a=r.webrtcStuff;return null===a.pc||void 0===a.pc?(Janus.warn("Invalid PeerConnection"),!0):void 0===a.myStream||null===a.myStream?(Janus.warn("Invalid local MediaStream"),!0):n?null===a.myStream.getVideoTracks()||void 0===a.myStream.getVideoTracks()||0===a.myStream.getVideoTracks().length?(Janus.warn("No video track"),!0):!a.myStream.getVideoTracks()[0].enabled:null===a.myStream.getAudioTracks()||void 0===a.myStream.getAudioTracks()||0===a.myStream.getAudioTracks().length?(Janus.warn("No audio track"),!0):!a.myStream.getAudioTracks()[0].enabled}function E(e,n,r){var a=J[e];if(null==a||null===a.webrtcStuff||void 0===a.webrtcStuff)return Janus.warn("Invalid handle"),!1;var t=a.webrtcStuff;return null===t.pc||void 0===t.pc?(Janus.warn("Invalid PeerConnection"),!1):void 0===t.myStream||null===t.myStream?(Janus.warn("Invalid local MediaStream"),!1):n?null===t.myStream.getVideoTracks()||void 0===t.myStream.getVideoTracks()||0===t.myStream.getVideoTracks().length?(Janus.warn("No video track"),!1):(t.myStream.getVideoTracks()[0].enabled=!r,!0):null===t.myStream.getAudioTracks()||void 0===t.myStream.getAudioTracks()||0===t.myStream.getAudioTracks().length?(Janus.warn("No audio track"),!1):(t.myStream.getAudioTracks()[0].enabled=!r,!0)}function F(e){var n=J[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return Janus.warn("Invalid handle"),"Invalid handle";var r=n.webrtcStuff;return null===r.pc||void 0===r.pc?"Invalid PeerConnection":r.pc.getStats?null===r.bitrate.timer||void 0===r.bitrate.timer?(Janus.log("Starting bitrate timer (via getStats)"),r.bitrate.timer=setInterval(function(){r.pc.getStats().then(function(e){e.forEach(function(e){if(e){var n=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?n=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(n=!0),n)if(r.bitrate.bsnow=e.bytesReceived,r.bitrate.tsnow=e.timestamp,null===r.bitrate.bsbefore||null===r.bitrate.tsbefore)r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow;else{var a=r.bitrate.tsnow-r.bitrate.tsbefore;"safari"==Janus.webRTCAdapter.browserDetails.browser&&(a/=1e3);var t=Math.round(8*(r.bitrate.bsnow-r.bitrate.bsbefore)/a);r.bitrate.value=t+" kbits/sec",r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow}}})})},1e3),"0 kbits/sec"):r.bitrate.value:(Janus.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser")}function L(e){Janus.error("WebRTC error:",e)}function N(e,a){Janus.log("Cleaning WebRTC stuff");var t=J[e];if(null!=t){var o=t.webrtcStuff;if(null!=o){if(!0===a){var s={janus:"hangup",transaction:Janus.randomString(12)};null!==t.token&&void 0!==t.token&&(s.token=t.token),null!=p&&(s.apisecret=p),Janus.debug("Sending hangup request (handle="+e+"):"),Janus.debug(s),n?(s.session_id=b,s.handle_id=e,r.send(JSON.stringify(s))):Janus.httpAPICall(i+"/"+b+"/"+e,{verb:"POST",withCredentials:f,body:s})}o.remoteStream=null,o.volume.timer&&clearInterval(o.volume.timer),o.volume.value=null,o.bitrate.timer&&clearInterval(o.bitrate.timer),o.bitrate.timer=null,o.bitrate.bsnow=null,o.bitrate.bsbefore=null,o.bitrate.tsnow=null,o.bitrate.tsbefore=null,o.bitrate.value=null;try{if(!o.streamExternal&&null!==o.myStream&&void 0!==o.myStream){Janus.log("Stopping local stream tracks");var d=o.myStream.getTracks();for(var u in d){var c=d[u];Janus.log(c),null!=c&&c.stop()}}}catch(e){}o.streamExternal=!1,o.myStream=null;try{o.pc.close()}catch(e){}o.pc=null,o.candidates=null,o.mySdp=null,o.remoteSdp=null,o.iceDone=!1,o.dataChannel=null,o.dtmfSender=null}t.oncleanup()}}function U(e){return Janus.debug("isAudioSendEnabled:",e),null==e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function W(e){return Janus.debug("isAudioRecvEnabled:",e),null==e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function _(e){return Janus.debug("isVideoSendEnabled:",e),null==e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function q(e){return Janus.debug("isVideoRecvEnabled:",e),null==e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}A(e),this.getServer=function(){return i},this.isConnected=function(){return m},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.reconnect=!0,A(e)},this.getSessionId=function(){return b},this.destroy=function(o){!function(o){(o=o||{}).success="function"==typeof o.success?o.success:Janus.noop;var s=!0;void 0!==o.asyncRequest&&null!==o.asyncRequest&&(s=!0===o.asyncRequest);var d=!0;void 0!==o.notifyDestroyed&&null!==o.notifyDestroyed&&(d=!0===o.notifyDestroyed);if(Janus.log("Destroying session "+b+" (async="+s+")"),!m)return Janus.warn("Is the gateway down? (connected=false)"),void o.success();if(null==b)return Janus.warn("No session to destroy"),o.success(),void(d&&e.destroyed());delete Janus.sessions[b];var u={janus:"destroy",transaction:Janus.randomString(12)};null!=g&&(u.token=g);null!=p&&(u.apisecret=p);if(n){u.session_id=b;var c=function(){for(var e in a)r.removeEventListener(e,a[e]);r.removeEventListener("message",l),r.removeEventListener("error",v),t&&clearTimeout(t),r.close()},l=function(n){var r=JSON.parse(n.data);r.session_id==u.session_id&&r.transaction==u.transaction&&(c(),o.success(),d&&e.destroyed())},v=function(n){c(),o.error("Failed to destroy the gateway: Is the gateway down?"),d&&e.destroyed()};return r.addEventListener("message",l),r.addEventListener("error",v),void r.send(JSON.stringify(u))}Janus.httpAPICall(i+"/"+b,{verb:"POST",async:s,withCredentials:f,body:u,success:function(n){Janus.log("Destroyed session:"),Janus.debug(n),b=null,m=!1,"success"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),o.success(),d&&e.destroyed()},error:function(n,r){Janus.error(n+":",r),b=null,m=!1,o.success(),d&&e.destroyed()}})}(o)},this.attach=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:Janus.noop,e.iceState="function"==typeof e.iceState?e.iceState:Janus.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:Janus.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:Janus.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:Janus.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:Janus.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:Janus.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:Janus.noop,e.ondata="function"==typeof e.ondata?e.ondata:Janus.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:Janus.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:Janus.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:Janus.noop,!m)return Janus.warn("Is the gateway down? (connected=false)"),void e.error("Is the gateway down? (connected=false)");var a=e.plugin;if(null==a)return Janus.error("Invalid plugin"),void e.error("Invalid plugin");var t=e.opaqueId,o=e.token?e.token:g,s=Janus.randomString(12),d={janus:"attach",plugin:a,opaque_id:t,transaction:s};null!=o&&(d.token=o);null!=p&&(d.apisecret=p);if(n)return y[s]=function(n){if(Janus.debug(n),"success"!==n.janus)return Janus.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var r=n.data.id;Janus.log("Created handle: "+r);var t={session:w,plugin:a,id:r,token:o,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return a},getVolume:function(){return M(r)},isAudioMuted:function(){return P(r,!1)},muteAudio:function(){return E(r,!1,!0)},unmuteAudio:function(){return E(r,!1,!1)},isVideoMuted:function(){return P(r,!0)},muteVideo:function(){return E(r,!0,!0)},unmuteVideo:function(){return E(r,!0,!1)},getBitrate:function(){return F(r)},send:function(e){C(r,e)},data:function(e){R(r,e)},dtmf:function(e){I(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){j(r,e)},createAnswer:function(e){j(r,e)},handleRemoteJsep:function(e){O(r,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){N(r,!0===e)},detach:function(e){x(r,e)}};J[r]=t,e.success(t)},d.session_id=b,void r.send(JSON.stringify(d));Janus.httpAPICall(i+"/"+b,{verb:"POST",withCredentials:f,body:d,success:function(n){if(Janus.debug(n),"success"!==n.janus)return Janus.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var r=n.data.id;Janus.log("Created handle: "+r);var t={session:w,plugin:a,id:r,token:o,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return a},getVolume:function(){return M(r)},isAudioMuted:function(){return P(r,!1)},muteAudio:function(){return E(r,!1,!0)},unmuteAudio:function(){return E(r,!1,!1)},isVideoMuted:function(){return P(r,!0)},muteVideo:function(){return E(r,!0,!0)},unmuteVideo:function(){return E(r,!0,!1)},getBitrate:function(){return F(r)},send:function(e){C(r,e)},data:function(e){R(r,e)},dtmf:function(e){I(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){j(r,e)},createAnswer:function(e){j(r,e)},handleRemoteJsep:function(e){O(r,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){N(r,!0===e)},detach:function(e){x(r,e)}};J[r]=t,e.success(t)},error:function(e,n){Janus.error(e+":",n)}})}(e)}}Janus.sessions={},Janus.extensionId="hapfgfdkleiggjjpfpenajgdnfckjpaj",Janus.isExtensionEnabled=function(){if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),n=33;return window.navigator.userAgent.match("Linux")&&(n=35),e>=26&&e<=n||Janus.checkJanusExtension()}return!0},Janus.useDefaultDependencies=function(e){var n=e&&e.fetch||fetch,r=e&&e.Promise||Promise,a=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,n){return new a(e,n)},isArray:function(e){return Array.isArray(e)},checkJanusExtension:function(){return null!==document.querySelector("#janus-extension-installed")},webRTCAdapter:e&&e.webRTCAdapter||adapter,httpAPICall:function(e,a){var t={method:a.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===a.verb&&(t.headers["Content-Type"]="application/json"),void 0!==a.withCredentials&&(t.credentials=!0===a.withCredentials?"include":a.withCredentials?a.withCredentials:"omit"),void 0!==a.body&&(t.body=JSON.stringify(a.body));var o=n(e,t).catch(function(e){return r.reject({message:"Probably a network error, is the gateway down?",error:e})});if(void 0!==a.timeout){var s=new r(function(e,n){var r=setTimeout(function(){return clearTimeout(r),n({message:"Request timed out",timeout:a.timeout})},a.timeout)});o=r.race([o,s])}return o.then(function(e){return e.ok?typeof a.success==typeof Janus.noop?e.json().then(function(e){a.success(e)}).catch(function(n){return r.reject({message:"Failed to parse response body",error:n,response:e})}):void 0:r.reject({message:"API call failed",response:e})}).catch(function(e){typeof a.error==typeof Janus.noop&&a.error(e.message||"<< internal error >>",e)}),o}}},Janus.useOldDependencies=function(e){var n=e&&e.jQuery||jQuery,r=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,n){return new r(e,n)},isArray:function(e){return n.isArray(e)},checkJanusExtension:function(){return n("#janus-extension-installed").length>0},webRTCAdapter:e&&e.webRTCAdapter||adapter,httpAPICall:function(e,r){var a=void 0!==r.body?{contentType:"application/json",data:JSON.stringify(r.body)}:{},t=void 0!==r.withCredentials?{xhrFields:{withCredentials:r.withCredentials}}:{};return n.ajax(n.extend(a,t,{url:e,type:r.verb,cache:!1,dataType:"json",async:r.async,timeout:r.timeout,success:function(e){typeof r.success==typeof Janus.noop&&r.success(e)},error:function(e,n,a){typeof r.error==typeof Janus.noop&&r.error(n,a)}}))}}},Janus.noop=function(){},Janus.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:Janus.noop,!0===Janus.initDone)e.callback();else{if("undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),Janus.trace=Janus.noop,Janus.debug=Janus.noop,Janus.vdebug=Janus.noop,Janus.log=Janus.noop,Janus.warn=Janus.noop,Janus.error=Janus.noop,!0===e.debug||"all"===e.debug)Janus.trace=console.trace.bind(console),Janus.debug=console.debug.bind(console),Janus.vdebug=console.debug.bind(console),Janus.log=console.log.bind(console),Janus.warn=console.warn.bind(console),Janus.error=console.error.bind(console);else if(Array.isArray(e.debug))for(var n in e.debug){var r=e.debug[n];switch(r){case"trace":Janus.trace=console.trace.bind(console);break;case"debug":Janus.debug=console.debug.bind(console);break;case"vdebug":Janus.vdebug=console.debug.bind(console);break;case"log":Janus.log=console.log.bind(console);break;case"warn":Janus.warn=console.warn.bind(console);break;case"error":Janus.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+r+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}}Janus.log("Initializing library");var a=null;a=!e||!e.dependencies||e.dependencies.isArray&&e.dependencies.webRTCAdapter&&e.dependencies.httpAPICall&&e.dependencies.checkJanusExtension&&!e.dependencies.newWebSocket?e.dependencies:Janus.useDefaultDependencies(e.dependencies),Janus.isArray=a.isArray,Janus.webRTCAdapter=a.webRTCAdapter,Janus.httpAPICall=a.httpAPICall,Janus.checkJanusExtension=a.checkJanusExtension,Janus.newWebSocket=a.newWebSocket,Janus.listDevices=function(e,n){e="function"==typeof e?e:Janus.noop,null==n&&(n={audio:!0,video:!0}),navigator.mediaDevices?navigator.mediaDevices.getUserMedia(n).then(function(n){navigator.mediaDevices.enumerateDevices().then(function(r){Janus.debug(r),e(r);try{var a=n.getTracks();for(var t in a){var o=a[t];null!=o&&o.stop()}}catch(e){}})}).catch(function(n){Janus.error(n),e([])}):(Janus.warn("navigator.mediaDevices unavailable"),e([]))},Janus.attachMediaStream=function(e,n){"chrome"===Janus.webRTCAdapter.browserDetails.browser?Janus.webRTCAdapter.browserDetails.version>=43?e.srcObject=n:void 0!==e.src?e.src=URL.createObjectURL(n):Janus.error("Error attaching stream to element"):e.srcObject=n},Janus.reattachMediaStream=function(e,n){"chrome"===Janus.webRTCAdapter.browserDetails.browser?Janus.webRTCAdapter.browserDetails.version>=43?e.srcObject=n.srcObject:void 0!==e.src?e.src=n.src:Janus.error("Error reattaching stream to element"):e.srcObject=n.srcObject};var t=window.onbeforeunload;window.onbeforeunload=function(){for(var e in Janus.log("Closing window"),Janus.sessions)null!==Janus.sessions[e]&&void 0!==Janus.sessions[e]&&Janus.sessions[e].destroyOnUnload&&(Janus.log("Destroying session "+e),Janus.sessions[e].destroy({asyncRequest:!1,notifyDestroyed:!1}));t&&"function"==typeof t&&t()},Janus.initDone=!0,e.callback()}},Janus.isWebrtcSupported=function(){return void 0!==window.RTCPeerConnection&&null!==window.RTCPeerConnection&&void 0!==navigator.getUserMedia&&null!==navigator.getUserMedia},Janus.randomString=function(e){for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="",a=0;a<e;a++){var t=Math.floor(Math.random()*n.length);r+=n.substring(t,t+1)}return r};
